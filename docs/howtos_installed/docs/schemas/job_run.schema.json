{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://codesentinel.dev/schemas/job_run.schema.json",
  "title": "CodeSentinel Job Execution Manifest",
  "description": "Structured record for any CodeSentinel job run, capturing tier, litmus results, approvals, artifacts, and reporting outputs.",
  "type": "object",
  "additionalProperties": false,
  "required": [
    "job_id",
    "tier",
    "title",
    "owner_call_sign",
    "started_at",
    "status",
    "prechecks",
    "cli_reuse",
    "agent_scripts_scan",
    "cost_assessment",
    "actions",
    "artifacts",
    "approvals",
    "reporting",
    "outcome"
  ],
  "properties": {
    "job_id": {
      "type": "string",
      "pattern": "^[a-z0-9_.\\-]+$",
      "description": "Stable identifier for the job (kebab or snake case)."
    },
    "tier": {
      "type": "string",
      "enum": ["J0", "J1", "J2", "J3", "J4"],
      "description": "Classification tier applied to this job."
    },
    "title": {
      "type": "string",
      "description": "Human-friendly job label."
    },
    "owner_call_sign": {
      "type": "string",
      "description": "ORACL call sign responsible for the run (e.g., ORACL-Prime)."
    },
    "participants": {
      "type": "array",
      "items": {
        "type": "string"
      },
      "description": "Optional list of additional agent call signs assisting the job."
    },
    "started_at": {
      "type": "string",
      "format": "date-time",
      "description": "Job start timestamp."
    },
    "completed_at": {
      "type": "string",
      "format": "date-time",
      "description": "Job completion timestamp (if finished)."
    },
    "status": {
      "type": "string",
      "enum": ["in-progress", "succeeded", "failed", "rolled_back"],
      "description": "Overall run status."
    },
    "prechecks": {
      "type": "object",
      "additionalProperties": false,
      "required": ["litmus"],
      "properties": {
        "litmus": {
          "type": "object",
          "additionalProperties": false,
          "required": ["executed", "outcome", "rationale"],
          "properties": {
            "executed": {
              "type": "boolean",
              "description": "Whether the litmus guard ran prior to cost assessment."
            },
            "outcome": {
              "type": "string",
              "enum": ["pass", "skip", "escalate"],
              "description": "Result of the litmus guard."
            },
            "rationale": {
              "type": "string",
              "description": "Reasoning for the outcome (e.g., low-risk, jumped to full cost assessment)."
            },
            "elapsed_ms": {
              "type": "integer",
              "minimum": 0,
              "description": "Execution time of the litmus check in milliseconds."
            }
          }
        }
      }
    },
    "cli_reuse": {
      "type": "object",
      "additionalProperties": false,
      "required": ["checked", "command"],
      "properties": {
        "checked": {
          "type": "boolean",
          "description": "True if the agent confirmed no existing CLI command solves the task."
        },
        "command": {
          "type": "string",
          "description": "Existing CLI command reused or 'none'."
        },
        "notes": {
          "type": "string",
          "description": "Optional explanation if no CLI was available."
        }
      }
    },
    "agent_scripts_scan": {
      "type": "object",
      "additionalProperties": false,
      "required": ["checked", "matches", "decision"],
      "properties": {
        "checked": {
          "type": "boolean",
          "description": "True if the agent scanned scripts/agent/ for reuse before writing code."
        },
        "matches": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "List of matching scripts or snippets that could be reused."
        },
        "decision": {
          "type": "string",
          "description": "Outcome of the scan (reused snippet path, documented no-match, etc.)."
        }
      }
    },
    "cost_assessment": {
      "type": "object",
      "additionalProperties": false,
      "required": ["performed", "summary"],
      "properties": {
        "performed": {
          "type": "boolean",
          "description": "True if a full cost assessment ran after the litmus guard."
        },
        "summary": {
          "type": "string",
          "description": "Key findings (estimates, trade-offs, branching paths)."
        },
        "effort_score": {
          "type": "integer",
          "minimum": 1,
          "maximum": 5,
          "description": "Relative effort score (1 = trivial, 5 = complex)."
        },
        "security_score": {
          "type": "integer",
          "minimum": 1,
          "maximum": 5,
          "description": "Security risk score assigned during assessment."
        },
        "minimalism_score": {
          "type": "integer",
          "minimum": 1,
          "maximum": 5,
          "description": "Minimalism risk score (duplication, source-of-truth danger)."
        }
      }
    },
    "actions": {
      "type": "object",
      "additionalProperties": false,
      "required": ["commands", "files_touched"],
      "properties": {
        "commands": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Executed commands or scripts (repository-relative when possible)."
        },
        "files_touched": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Repository-relative paths that were modified."
        }
      }
    },
    "artifacts": {
      "type": "array",
      "items": {
        "type": "object",
        "additionalProperties": false,
        "required": ["type", "path"],
        "properties": {
          "type": {
            "type": "string",
            "enum": ["markdown", "json", "log", "binary", "screenshot"],
            "description": "Artifact content type."
          },
          "path": {
            "type": "string",
            "description": "Repository-relative path to the artifact."
          },
          "description": {
            "type": "string",
            "description": "Short explanation of the artifact."
          }
        }
      }
    },
    "approvals": {
      "type": "array",
      "items": {
        "type": "object",
        "additionalProperties": false,
        "required": ["role", "decision", "timestamp"],
        "properties": {
          "role": {
            "type": "string"
          },
          "user": {
            "type": "string"
          },
          "decision": {
            "type": "string",
            "enum": ["approved", "rejected", "waived"],
            "description": "Outcome of the approval step."
          },
          "timestamp": {
            "type": "string",
            "format": "date-time"
          },
          "notes": {
            "type": "string"
          }
        }
      },
      "description": "Approval trail for this job (may be empty for J0/J1 if not required)."
    },
    "reporting": {
      "type": "object",
      "additionalProperties": false,
      "required": ["channels", "manifests"],
      "properties": {
        "channels": {
          "type": "array",
          "items": {
            "type": "string",
            "enum": ["logs", "docs", "alerts", "context_tier", "intelligence_tier"]
          },
          "description": "Destinations where the outputs were published."
        },
        "manifests": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Paths to manifest files (job run manifest, data manifest, etc.)."
        }
      }
    },
    "outcome": {
      "type": "object",
      "additionalProperties": false,
      "required": ["summary"],
      "properties": {
        "summary": {
          "type": "string",
          "description": "Narrative outcome statement."
        },
        "rollback_plan": {
          "type": "string",
          "description": "Rollback or mitigation steps (required for J3/J4)."
        },
        "followups": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "List of follow-up tasks or tickets spawned by this job."
        }
      }
    }
  }
}
