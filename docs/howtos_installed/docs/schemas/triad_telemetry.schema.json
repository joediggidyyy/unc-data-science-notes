{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://codesentinel.internal/schemas/triad_telemetry.schema.json",
  "title": "CIDS Triad Telemetry Schema",
  "description": "Standardized telemetry format for Sentry Triad components (Sentry, Watchdog, Cortex)",
  "type": "object",
  "required": ["timestamp", "triad_component", "persona_id", "node_role", "event_type", "status"],
  "properties": {
    "timestamp": {
      "type": "string",
      "format": "date-time",
      "description": "ISO 8601 timestamp of the event"
    },
    "triad_component": {
      "type": "string",
      "enum": ["sentry", "watchdog", "cortex"],
      "description": "Which triad component generated this event"
    },
    "persona_id": {
      "type": "string",
      "pattern": "^PTID::[A-Z0-9]+::[a-z_]+$",
      "description": "Phase Deterministic Moniker persona tag",
      "examples": [
        "PTID::P2::edge_sentry_internal",
        "PTID::P2::edge_watchdog_external",
        "PTID::P2::brain_sentry"
      ]
    },
    "node_role": {
      "type": "string",
      "enum": ["edge", "brain", "admin", "satellite"],
      "description": "Node role in the CIDS ecosystem"
    },
    "lane": {
      "type": "string",
      "enum": ["internal", "external", "single"],
      "description": "Lane designation for dual-lane nodes (Edge), or 'single' for single-instance nodes"
    },
    "event_type": {
      "type": "string",
      "enum": [
        "heartbeat",
        "health_check",
        "restart",
        "restart_attempt",
        "filesystem_drift",
        "port_snapshot",
        "port_anomaly",
        "anomaly",
        "differential",
        "quarantine"
      ],
      "description": "Type of event being reported"
    },
    "target": {
      "type": "string",
      "description": "Target systemd unit or monitored service",
      "examples": [
        "cids-sentry@internal.service",
        "cids-sentry.service"
      ]
    },
    "status": {
      "type": "string",
      "enum": ["active", "healthy", "failed", "warning", "anomalous", "quarantined"],
      "description": "Current status of the monitored component"
    },
    "metadata": {
      "type": "object",
      "description": "Event-specific metadata",
      "properties": {
        "check_interval": {
          "type": "number",
          "description": "Interval in seconds between checks"
        },
        "attempt": {
          "type": "integer",
          "description": "Restart attempt number"
        },
        "max_attempts": {
          "type": "integer",
          "description": "Maximum restart attempts before failure"
        },
        "success": {
          "type": "boolean",
          "description": "Whether the operation succeeded"
        },
        "restart_delay": {
          "type": "number",
          "description": "Delay in seconds between restart attempts"
        },
        "cortex_loaded": {
          "type": "boolean",
          "description": "Whether Cortex module is loaded in Sentry"
        },
        "uptime": {
          "type": "number",
          "description": "Service uptime in seconds"
        },
        "cpu_percent": {
          "type": "number",
          "description": "CPU usage percentage"
        },
        "memory_mb": {
          "type": "number",
          "description": "Memory usage in MB"
        },
        "port_count": {
          "type": "integer",
          "description": "Number of open ports detected"
        },
        "new_ports": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "port": {"type": "integer"},
              "protocol": {"type": "string"},
              "process": {"type": "string"}
            }
          },
          "description": "Newly detected ports since last snapshot"
        },
        "error": {
          "type": "string",
          "description": "Error message if operation failed"
        }
      }
    },
    "triad_context": {
      "type": "object",
      "description": "Cross-component triad context",
      "properties": {
        "sentry_health": {
          "type": "string",
          "enum": ["healthy", "degraded", "unknown"],
          "description": "Current Sentry health status"
        },
        "watchdog_active": {
          "type": "boolean",
          "description": "Whether Watchdog is actively monitoring"
        },
        "cortex_verdict": {
          "type": "string",
          "enum": ["benign", "suspicious", "malicious", "unknown"],
          "description": "Cortex anomaly verdict"
        },
        "related_events": {
          "type": "array",
          "items": {"type": "string"},
          "description": "Array of related event IDs from other triad components"
        }
      }
    }
  },
  "examples": [
    {
      "timestamp": "2025-12-11T09:30:00Z",
      "triad_component": "watchdog",
      "persona_id": "PTID::P2::edge_watchdog_internal",
      "node_role": "edge",
      "lane": "internal",
      "event_type": "health_check",
      "target": "cids-sentry@internal.service",
      "status": "active",
      "metadata": {
        "check_interval": 15,
        "cortex_loaded": true,
        "uptime": 3600
      }
    },
    {
      "timestamp": "2025-12-11T09:30:15Z",
      "triad_component": "cortex",
      "persona_id": "PTID::P2::edge_cortex_internal",
      "node_role": "edge",
      "lane": "internal",
      "event_type": "port_anomaly",
      "status": "anomalous",
      "metadata": {
        "port_count": 12,
        "new_ports": [
          {"port": 4444, "protocol": "tcp", "process": "unknown"}
        ]
      },
      "triad_context": {
        "cortex_verdict": "suspicious",
        "related_events": ["watchdog_check_12345"]
      }
    }
  ]
}
