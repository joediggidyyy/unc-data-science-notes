{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://codesentinel.dev/schemas/snippet_manifest.schema.json",
  "title": "CodeSentinel Snippet Manifest",
  "description": "Defines the metadata envelope for semantics_staging snippet artifacts so every snippet carries CaSTaP trace data, persona attribution, ORACall hooks, and prediction-ready adjacency metrics.",
  "type": "object",
  "additionalProperties": false,
  "required": [
    "manifest_version",
    "generated_at",
    "queststack_id",
    "oracall_feed_path",
    "chunk_dictionary_path",
    "snippets"
  ],
  "properties": {
    "manifest_version": {
      "type": "string",
      "pattern": "^\\d+\\.\\d+\\.\\d+(?:-[a-z0-9.]+)?$",
      "description": "Semantic version for the manifest schema (mirrors docs/schemas versioning)."
    },
    "generated_at": {
      "type": "string",
      "format": "date-time",
      "description": "UTC timestamp when this manifest snapshot was emitted."
    },
    "queststack_id": {
      "type": "string",
      "pattern": "^QS-[A-Z0-9-]+$",
      "description": "QuestStack identifier that authorized the snippet batch."
    },
    "task_reference": {
      "type": "string",
      "description": "Optional pointer to the execution plan task (e.g., Phase D â†’ Task 5.2)."
    },
    "default_persona_tag": {
      "$ref": "#/$defs/ptid",
      "description": "Fallback persona tag for snippets that inherit persona attribution from the build session."
    },
    "calamum_encoder_release": {
      "type": "string",
      "description": "Version or git ref of the CalamumEncoder release used for sealing snippet payloads."
    },
    "oracall_feed_path": {
      "type": "string",
      "pattern": "^docs/reports/feeds/.+\\.jsonl$",
      "description": "Relative path to the ORACall feed that indexes snippet events."
    },
    "chunk_dictionary_path": {
      "type": "string",
      "pattern": "^semantics_staging/.*chunk_dictionary\\.jsonl$",
      "description": "Location of the chunk dictionary referenced by snippet registry entries."
    },
    "snippets": {
      "type": "array",
      "minItems": 1,
      "items": {
        "$ref": "#/$defs/snippetEntry"
      }
    }
  },
  "$defs": {
    "ptid": {
      "type": "string",
      "pattern": "^PTID::(P[0-3])::[a-z0-9_:-]+$",
      "description": "Persona Tag Identifier (tier-prefixed slug)."
    },
    "hash64": {
      "type": "string",
      "pattern": "^[a-f0-9]{64}$",
      "description": "Hex-encoded SHA-256 hash."
    },
    "snippetId": {
      "type": "string",
      "pattern": "^SNIP-[A-F0-9]{8}$",
      "description": "Primary key for snippet entries."
    },
    "persona": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "persona_tag_id",
        "tier",
        "asserted_by",
        "evidence"
      ],
      "properties": {
        "persona_tag_id": {
          "$ref": "#/$defs/ptid"
        },
        "tier": {
          "type": "string",
          "enum": ["P0", "P1", "P2", "P3"],
          "description": "Persona tier derived from the PTID."
        },
        "asserted_by": {
          "type": "string",
          "description": "Process or automation that injected the persona (e.g., CalamumEncoder, persona_guard)."
        },
        "evidence": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Relative paths to logs or ORACall events proving persona attribution."
        }
      }
    },
    "calamum": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "trace_token",
        "encoder_version",
        "sealed",
        "context"
      ],
      "properties": {
        "trace_token": {
          "type": "string",
          "pattern": "^CST-[A-F0-9]{16}$",
          "description": "CaSTaP/Calamum trace token associated with the snippet."
        },
        "encoder_version": {
          "type": "string",
          "description": "Release identifier for CalamumEncoder used to seal or audit the snippet content."
        },
        "sealed": {
          "type": "boolean",
          "description": "Indicates whether the snippet payload was sealed before archival."
        },
        "context": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "edge_node": {"type": "string"},
            "session_id": {"type": "string"},
            "transport": {"type": "string", "enum": ["airlock", "p2p", "local"]},
            "notes": {"type": "string"}
          }
        }
      }
    },
    "registryReference": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "chunk_dictionary_hash",
        "source_artifact_id",
        "staging_manifest",
        "semantics_vault_entry"
      ],
      "properties": {
        "chunk_dictionary_hash": {
          "$ref": "#/$defs/hash64"
        },
        "source_artifact_id": {
          "type": "string",
          "description": "Identifier from semantics_staging manifest.json (hash prefix + timestamp)."
        },
        "staging_manifest": {
          "type": "string",
          "description": "Relative path to the artifact manifest that produced this snippet."
        },
        "semantics_vault_entry": {
          "type": "string",
          "description": "Path or identifier inside semantics_vault/oracl_index for the promoted chunk."
        }
      }
    },
    "oracallLink": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "component",
        "event_ids",
        "search_filters"
      ],
      "properties": {
        "component": {
          "type": "string",
          "enum": ["snippet_library"],
          "description": "ORACall component label recorded in the feed."
        },
        "event_ids": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "minItems": 1,
          "description": "IDs from ORACall feed entries anchoring this snippet."
        },
        "search_filters": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "persona": {"$ref": "#/$defs/ptid"},
            "component": {"type": "string"},
            "tags": {
              "type": "array",
              "items": {"type": "string"}
            }
          }
        }
      }
    },
    "sessionMemoryRef": {
      "type": "object",
      "additionalProperties": false,
      "required": ["tier", "path"],
      "properties": {
        "tier": {
          "type": "string",
          "enum": ["tier1", "tier2", "tier3"],
          "description": "SessionMemory tier that tracks snippet awareness."
        },
        "path": {
          "type": "string",
          "description": "Relative path to the SessionMemory export containing snippet telemetry."
        },
        "last_synced": {
          "type": "string",
          "format": "date-time"
        }
      }
    },
    "coOccurrenceEdge": {
      "type": "object",
      "additionalProperties": false,
      "required": ["next_snippet_id", "weight"],
      "properties": {
        "next_snippet_id": {
          "$ref": "#/$defs/snippetId"
        },
        "weight": {
          "type": "number",
          "minimum": 0,
          "description": "Normalized probability or score indicating likelihood of following snippet usage."
        },
        "observations": {
          "type": "integer",
          "minimum": 0,
          "description": "Raw observation count feeding the weight."
        },
        "contexts": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Context tags (e.g., 'pytest', 'network_router') that yielded the adjacency."
        }
      }
    },
    "metrics": {
      "type": "object",
      "additionalProperties": false,
      "required": ["usage_count", "first_used", "last_used"],
      "properties": {
        "usage_count": {
          "type": "integer",
          "minimum": 0
        },
        "first_used": {
          "type": "string",
          "format": "date-time"
        },
        "last_used": {
          "type": "string",
          "format": "date-time"
        },
        "avg_response_tokens": {
          "type": "number",
          "minimum": 0,
          "description": "Average token footprint when this snippet is surfaced to GPT-5.1-Codex."
        },
        "latency_budget_ms": {
          "type": "integer",
          "minimum": 0,
          "description": "Target latency budget for retrieving/rendering the snippet."
        }
      }
    },
    "compliance": {
      "type": "object",
      "additionalProperties": false,
      "required": ["policies", "last_audited"],
      "properties": {
        "policies": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "List of policy documents that govern this snippet (e.g., AGENT_INSTRUCTIONS JSON IDs)."
        },
        "last_audited": {
          "type": "string",
          "format": "date-time"
        },
        "auditor": {
          "type": "string"
        },
        "notes": {
          "type": "string"
        }
      }
    },
    "snippetEntry": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "snippet_id",
        "chunk_hash",
        "source_type",
        "language",
        "persona",
        "calamum",
        "registry_ref",
        "content_preview",
        "storage",
        "tags",
        "metrics",
        "prediction",
        "oracall",
        "awareness",
        "compliance"
      ],
      "properties": {
        "snippet_id": {
          "$ref": "#/$defs/snippetId"
        },
        "chunk_hash": {
          "$ref": "#/$defs/hash64"
        },
        "source_type": {
          "type": "string",
          "enum": ["shell_command", "python_script", "powershell_script", "snippet", "markdown"]
        },
        "language": {
          "type": "string",
          "description": "Primary language for syntax highlighting or execution."
        },
        "persona": {
          "$ref": "#/$defs/persona"
        },
        "calamum": {
          "$ref": "#/$defs/calamum"
        },
        "registry_ref": {
          "$ref": "#/$defs/registryReference"
        },
        "content_preview": {
          "type": "object",
          "additionalProperties": false,
          "required": ["first_line", "hash_excerpt", "token_estimate"],
          "properties": {
            "first_line": {"type": "string"},
            "hash_excerpt": {"type": "string"},
            "token_estimate": {"type": "integer", "minimum": 0}
          }
        },
        "storage": {
          "type": "object",
          "additionalProperties": false,
          "required": ["path", "integrity_sha256"],
          "properties": {
            "path": {
              "type": "string",
              "description": "Relative path to the snippet artifact (e.g., semantics_staging/snippets/foo.py)."
            },
            "sealed_blob": {
              "type": "string",
              "description": "Optional pointer to sealed blob or attachment." 
            },
            "integrity_sha256": {
              "$ref": "#/$defs/hash64"
            }
          }
        },
        "tags": {
          "type": "array",
          "items": {"type": "string"},
          "description": "Keyword tags (frameworks, domains, capabilities)."
        },
        "metrics": {
          "$ref": "#/$defs/metrics"
        },
        "prediction": {
          "type": "object",
          "additionalProperties": false,
          "required": ["primary_followups", "co_occurrence_graph", "last_compiled"],
          "properties": {
            "primary_followups": {
              "type": "array",
              "items": {
                "$ref": "#/$defs/snippetId"
              },
              "description": "Top-N snippet IDs most likely to follow this snippet."
            },
            "co_occurrence_graph": {
              "type": "array",
              "items": {
                "$ref": "#/$defs/coOccurrenceEdge"
              }
            },
            "last_compiled": {
              "type": "string",
              "format": "date-time"
            },
            "model_version": {
              "type": "string",
              "description": "Version of the predictor that generated the adjacency graph."
            }
          }
        },
        "oracall": {
          "$ref": "#/$defs/oracallLink"
        },
        "awareness": {
          "type": "object",
          "additionalProperties": false,
          "required": ["session_memory", "context_tier"],
          "properties": {
            "session_memory": {
              "type": "array",
              "minItems": 1,
              "items": {
                "$ref": "#/$defs/sessionMemoryRef"
              }
            },
            "context_tier": {
              "type": "array",
              "items": {
                "type": "string",
                "pattern": "^context_tier/.+\\.jsonl$"
              },
              "description": "Links into context_tier exports where snippet summaries reside."
            }
          }
        },
        "compliance": {
          "$ref": "#/$defs/compliance"
        }
      }
    }
  }
}
